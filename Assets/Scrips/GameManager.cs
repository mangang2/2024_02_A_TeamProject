using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;

public class GameManager : MonoBehaviour
{
    public GameObject Player;
    public GameObject ButtonTeleport;  // ButtonTeleport 위치 
    public GameObject TopTeleport;      // TopTeleport 위치
    public GameObject[] mapPrefabs;     // 랜덤으로 교체할 맵 프리팹들

    private int swapCount = 0;  // 교체 횟수를 저장하는 변수 추가
    private int previousIndex = -1;  // 이전에 선택된 맵의 인덱스를 저장하는 변수

    private void OnTriggerEnter(Collider collision)
    {
        if (collision.gameObject.CompareTag("ButtonTeleport"))
        {
            GameObject currentMapObject = GameObject.FindWithTag("Map");
            GameObject currentFakeMapObject = GameObject.FindWithTag("FakeMap");

            if (currentMapObject != null)
            {
                int randomIndex;

                // 이전 인덱스와 다른 인덱스를 선택
                do
                {
                    randomIndex = Random.Range(0, mapPrefabs.Length);
                } while (randomIndex == previousIndex);

                previousIndex = randomIndex;  // 이전 인덱스 업데이트
                GameObject randomPrefab = mapPrefabs[randomIndex];

                Destroy(currentMapObject);
                Instantiate(randomPrefab, currentMapObject.transform.position, currentMapObject.transform.rotation);

                Debug.Log($"Map이 랜덤 프리팹 '{randomPrefab.name}'로 교체되었습니다.");
                swapCount++;

                if (swapCount >= 5)
                {
                    Debug.Log("게임 종료!");
                    Application.Quit();
#if UNITY_EDITOR
                    UnityEditor.EditorApplication.isPlaying = false;
#endif
                }
            }
            else if (currentFakeMapObject != null)
            {
                Destroy(currentFakeMapObject);
                SceneManager.LoadScene(SceneManager.GetActiveScene().buildIndex);
            }

            Player.transform.position = ButtonTeleport.transform.position;
        }

        if (collision.gameObject.CompareTag("TopTeleport"))
        {
            GameObject currentMapObject = GameObject.FindWithTag("Map");
            GameObject currentFakeMapObject = GameObject.FindWithTag("FakeMap");

            if (currentMapObject != null)
            {
                Destroy(currentMapObject);
                SceneManager.LoadScene(SceneManager.GetActiveScene().buildIndex);
            }
            else if (currentFakeMapObject != null)
            {
                Destroy(currentFakeMapObject);

                int randomIndex;
                do
                {
                    randomIndex = Random.Range(0, mapPrefabs.Length);
                } while (randomIndex == previousIndex);

                previousIndex = randomIndex;  // 이전 인덱스 업데이트
                GameObject randomPrefab = mapPrefabs[randomIndex];

                Instantiate(randomPrefab, currentFakeMapObject.transform.position, currentFakeMapObject.transform.rotation);

                Debug.Log($"FakeMap이 랜덤 프리팹 '{randomPrefab.name}'로 교체되었습니다.");
                swapCount++;

                if (swapCount >= 5)
                {
                    Debug.Log("게임 종료!");
                    Application.Quit();
#if UNITY_EDITOR
                    UnityEditor.EditorApplication.isPlaying = false;
#endif
                }
            }

            Player.transform.position = TopTeleport.transform.position;
        }
    }
}



